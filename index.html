<!DOCTYPE html>
<html>
  <head>
    <style>
      body {
        font-family: Inter, sans-serif;
        padding: 20px;
        margin: 0;
      }
      .container {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .settings {
        border: 1px solid #e5e5e5;
        padding: 16px;
        border-radius: 8px;
      }
      .api-key-input {
        width: 100%;
        padding: 8px;
        margin: 8px 0;
        box-sizing: border-box;
      }
      .button {
        background: #18a0fb;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        width: 100%;
      }
      .button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      #status {
        margin-top: 8px;
        color: #666;
      }
      #videoContainer {
        margin-top: 16px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="settings">
        <h3>Runway API Settings</h3>
        <input
          type="password"
          id="apiKey"
          class="api-key-input"
          placeholder="Enter your Runway API key"
        />
        <button id="saveApiKey" class="button">Save API Key</button>
        <p id="apiKeyStatus"></p>
      </div>

      <div id="videoGeneration" style="display: none">
        <h3>Video Generation</h3>
        <button id="generateVideo" class="button">Generate Video</button>
        <div id="status"></div>
        <div id="videoContainer"></div>
      </div>
    </div>

    <script>
      // Get DOM elements
      const apiKeyInput = document.getElementById("apiKey");
      const saveApiKeyButton = document.getElementById("saveApiKey");
      const apiKeyStatus = document.getElementById("apiKeyStatus");
      const videoGeneration = document.getElementById("videoGeneration");
      const generateVideoButton = document.getElementById("generateVideo");
      const statusElement = document.getElementById("status");

      // Request the API key when page loads
      parent.postMessage(
        {
          pluginMessage: {
            type: "get-api-key",
          },
          pluginId: "1502691635872451437",
        },
        "*"
      );

      // Handle save API key
      saveApiKeyButton.onclick = () => {
        const apiKey = apiKeyInput.value.trim();
        if (apiKey) {
          parent.postMessage(
            {
              pluginMessage: {
                type: "save-api-key",
                apiKey,
              },
              pluginId: "1502691635872451437",
            },
            "*"
          );
        }
      };

      // Handle generate video
      generateVideoButton.onclick = () => {
        statusElement.textContent = "";
        parent.postMessage(
          {
            pluginMessage: {
              type: "generate-video",
            },
            pluginId: "1502691635872451437",
          },
          "*"
        );
      };

      async function pollTaskStatus(taskId, apiKey) {
        while (true) {
          await new Promise((resolve) => setTimeout(resolve, 2000));

          const statusResponse = await fetch(
            `https://proxy.corsfix.com/?https://api.dev.runwayml.com/v1/tasks/${taskId}`,
            {
              headers: {
                Authorization: `Bearer ${apiKey}`,
                "X-Runway-Version": "2024-09-13",
              },
            }
          );

          if (!statusResponse.ok) {
            const error = await statusResponse.json();
            throw new Error(error.message || "Failed to check task status");
          }

          const statusData = await statusResponse.json();

          if (statusData.status === "SUCCEEDED") {
            return statusData.output[0];
          } else if (statusData.status === "FAILED") {
            throw new Error("Video generation failed");
          }

          statusElement.textContent = "Generating video...";
        }
      }

      // Listen for messages from the plugin
      window.onmessage = async (event) => {
        const message = event.data.pluginMessage;

        if (message.type === "api-key-loaded") {
          apiKeyInput.value = message.apiKey || "";
          apiKeyStatus.textContent = message.apiKey
            ? "API key saved"
            : "No API key saved";
          videoGeneration.style.display = message.apiKey ? "block" : "none";
        } else if (message.type === "api-key-saved") {
          apiKeyStatus.textContent = "API key saved successfully";
          videoGeneration.style.display = "block";
        } else if (message.type === "image-ready") {
          const apiKey = apiKeyInput.value.trim();
          if (!apiKey) {
            statusElement.textContent =
              "Error: Please set your Runway API key first";
            return;
          }

          try {
            statusElement.textContent = "Starting video generation...";

            const response = await fetch(
              "https://proxy.corsfix.com/?https://api.dev.runwayml.com/v1/image_to_video",
              {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${apiKey}`,
                  "X-Runway-Version": "2024-09-13",
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  promptImage: message.imageData,
                  seed: Math.floor(Math.random() * 1000000000),
                  model: "gen3a_turbo",
                  promptText: "Generate a video",
                  watermark: false,
                  duration: 5,
                  ratio: "9:16",
                }),
              }
            );

            if (!response.ok) {
              const error = await response.json();
              throw new Error(
                error.message || "Failed to start video generation"
              );
            }

            const data = await response.json();
            const videoUrl = await pollTaskStatus(data.id, apiKey);

            statusElement.textContent = "Video generated successfully!";
            const videoContainer = document.getElementById("videoContainer");
            videoContainer.innerHTML = `<video controls src="${videoUrl}" width="100%" height="auto"></video>`;

            // Send video URL back to plugin code
            parent.postMessage(
              {
                pluginMessage: {
                  type: "video-ready",
                  videoUrl: videoUrl,
                },
                pluginId: "1502691635872451437",
              },
              "*"
            );
          } catch (error) {
            statusElement.textContent = `Error: ${error.message}`;
          }
        } else if (message.type === "error") {
          statusElement.textContent = `Error: ${message.error}`;
        }
      };
    </script>
  </body>
</html>
